import{_ as V,K as f,a4 as $,a2 as x,b as g,w as l,a5 as y,o as d,a as s,a6 as C,a7 as k,c,d as w,$ as F,h as u,k as m,t as p,a8 as S,a9 as _,aa as B,F as L,a3 as O,ab as A,f as b}from"../index.js";import{F as U}from"./FileListItems-DWefVW-z.js";const D={components:{FileListItems:U},props:{modelValue:{type:Boolean,required:!0},context:{type:[Object,null],default:null}},emits:["update:modelValue","add"],inject:["slugify","url"],setup(){const e=$();return{app:x(),messages:e}},data(){return{input:"",items:[],errors:[],similar:[],loading:!1}},beforeMount(){var i;const e=(i=this.context)==null?void 0:i.data,t=[e==null?void 0:e.title,e==null?void 0:e.text,e==null?void 0:e.description].filter(Boolean).join(`
`);t&&(this.input=this.$gettext("Generate a suitable image for")+`:
`+t)},unmounted(){this.items.forEach(e=>{e.path.startsWith("blob:")&&URL.revokeObjectURL(e.path)}),this.similar=[],this.items=[]},methods:{add(e){this.loading=!0,fetch(e.path).then(t=>t.blob()).then(t=>{const i=this.slugify(e.name)+"_"+new Date().toISOString().replace(/[^0-9]/g,"")+".png";return this.$apollo.mutate({mutation:f`mutation($input: FileInput, $file: Upload) {
              addFile(input: $input, file: $file) {
                id
                mime
                name
                path
                previews
                updated_at
                editor
              }
            }`,variables:{input:{name:e.name},file:new File([t],i,{type:e.mime})},context:{hasUpload:!0}})}).then(t=>{if(t.errors)throw t.errors;Object.assign(e,t.data.addFile,{previews:JSON.parse(t.data.addFile.previews||"{}")}),this.$emit("add",[e])}).catch(t=>{this.messages.add(this.$gettext("Error adding file %{path}",{path:e==null?void 0:e.path}),"error"),this.$log("FileAiDialog::add(): Error adding file",t)}).finally(()=>{this.loading=!1})},base64ToBlob(e,t="image/png"){if(!e)return null;const i=atob(e),r=new Uint8Array(i.length);for(let a=0;a<i.length;a++)r[a]=i.charCodeAt(a);return new Blob([r],{type:t})},create(){!this.input||this.loading||(this.loading=!0,this.original=this.input,this.$apollo.mutate({mutation:f`mutation($prompt: String!, $context: String, $files: [String!]) {
            imagine(prompt: $prompt, context: $context, files: $files)
          }`,variables:{prompt:this.input,context:this.context?`Context in JSON format:
`+JSON.stringify(this.context):"",files:this.similar.map(e=>e.path)}}).then(e=>{if(e.errors)throw e.errors;const t=this.input,i=e.data.imagine;this.input=i.shift()||this.input,i.forEach(r=>{this.items.unshift({path:URL.createObjectURL(this.base64ToBlob(r)),name:t.slice(0,t.length>100?t.lastIndexOf(" ",100):100),mime:"image/png"})})}).catch(e=>{this.$log("FileAiDialog::create(): Error creating files",e)}).finally(()=>{this.loading=!1}))},remove(e){this.items.splice(e,1)},removeSimilar(e){this.similar.splice(e,1)},use(e){this.similar.find(t=>t.path===e.path)||this.similar.push(e)}}},N={key:0},T=["onClick"],j=["src"];function E(e,t,i,r,a,o){return d(),g(y,{modelValue:i.modelValue,onAfterLeave:t[3]||(t[3]=n=>e.$emit("update:modelValue",!1)),"max-width":"1200",scrollable:""},{default:l(()=>[s(C,{loading:a.loading?"primary":!1},{append:l(()=>[s(u,{onClick:t[0]||(t[0]=n=>e.$emit("update:modelValue",!1)),title:e.$gettext("Close"),icon:"mdi-close",variant:"flat"},null,8,["title"])]),title:l(()=>[m(p(e.$gettext("Create image")),1)]),default:l(()=>[s(k,null,{default:l(()=>[s(F,{modelValue:a.input,"onUpdate:modelValue":t[1]||(t[1]=n=>a.input=n),label:e.$gettext("Describe the image"),variant:"underlined",autofocus:"",clearable:""},null,8,["modelValue","label"]),s(u,{loading:a.loading?"primary":!1,disabled:!a.input||a.loading,onClick:t[2]||(t[2]=n=>o.create()),color:"primary",variant:"outlined",class:"create"},{default:l(()=>[m(p(e.$gettext("Create image")),1)]),_:1},8,["loading","disabled"]),a.items.length?(d(),c("div",N,[s(S,null,{default:l(()=>[s(_,null,{default:l(()=>[m(p(e.$gettext("Generated images")),1)]),_:1})]),_:1}),s(B,{class:"items grid"},{default:l(()=>[(d(!0),c(L,null,O(a.items,(n,h)=>(d(),g(A,{key:h},{default:l(()=>[s(u,{onClick:v=>o.remove(h),title:e.$gettext("Remove"),class:"btn-overlay",icon:"mdi-delete"},null,8,["onClick","title"]),b("div",{class:"item-preview",onClick:v=>o.add(n)},[b("img",{src:o.url(n.path)},null,8,j)],8,T)]),_:2},1024))),128))]),_:1})])):w("",!0)]),_:1})]),_:1},8,["loading"])]),_:1},8,["modelValue"])}const J=V(D,[["render",E],["__scopeId","data-v-7b9dafff"]]);export{J as F};
