import{_ as S,a6 as w,L as y,a7 as L,a4 as B,b as p,o as d,w as l,a8 as O,r as U,a,a9 as I,aa as A,c as g,d as V,a1 as D,k as m,l as h,t as c,ab as b,ac as v,i as C,F as $,a5 as k,j as _,f,n as T}from"./index-BbU18Jta.js";import{F as j}from"./FileListItems-B37Xg4GC.js";const E={components:{FileListItems:j},props:{modelValue:{type:Boolean,required:!0},context:{type:[Object,null],default:null}},emits:["update:modelValue","add"],inject:["slugify","transcribe","url"],setup(){const e=L();return{app:B(),messages:e}},data(){return{audio:null,chat:"",items:[],errors:[],similar:[],loading:!1,dictating:!1}},beforeUpdate(){var e,t,s;this.chat=[(e=this.context)==null?void 0:e.title,(t=this.context)==null?void 0:t.text,(s=this.context)==null?void 0:s.description].filter(Boolean).join(`
`)},unmounted(){this.items.forEach(e=>{e.path.startsWith("blob:")&&URL.revokeObjectURL(e.path)}),this.similar=[],this.items=[]},methods:{add(e){if(!e.path.startsWith("blob:")){this.$emit("add",[e]);return}this.loading=!0,fetch(e.path).then(t=>t.blob()).then(t=>{const s=e.name.slice(0,e.name.length>50?e.name.lastIndexOf(" ",50):50)||"ai-image",o=this.slugify(s)+"_"+new Date().toISOString().replace(/[^0-9]/g,"")+".png";return this.$apollo.mutate({mutation:y`mutation($input: FileInput, $file: Upload) {
              addFile(input: $input, file: $file) {
                id
                mime
                name
                path
                previews
                updated_at
                editor
              }
            }`,variables:{input:{name:e.name},file:new File([t],o,{type:e.mime})},context:{hasUpload:!0}})}).then(t=>{if(t.errors)throw t.errors;Object.assign(e,t.data.addFile,{previews:JSON.parse(t.data.addFile.previews||"{}")}),this.$emit("add",[e])}).catch(t=>{this.messages.add(this.$gettext("Error adding file %{path}",{path:e==null?void 0:e.path})+`:
`+t,"error"),this.$log("FileAiDialog::add(): Error adding file",t)}).finally(()=>{this.loading=!1})},base64ToBlob(e,t="image/png"){if(!e)return null;const s=atob(e),o=new Uint8Array(s.length);for(let i=0;i<s.length;i++)o[i]=s.charCodeAt(i);return new Blob([o],{type:t})},create(){!this.chat||this.loading||(this.loading=!0,this.original=this.chat,this.$apollo.mutate({mutation:y`mutation($prompt: String!, $context: String, $files: [String!]) {
            imagine(prompt: $prompt, context: $context, files: $files)
          }`,variables:{prompt:this.chat||"Create a suitable image based on the context",context:this.context?`Context in JSON format:
`+JSON.stringify(this.context):"",files:this.similar.map(e=>e.id)}}).then(e=>{if(e.errors)throw e.errors;const t=this.chat,s=e.data.imagine;this.chat=s.shift()||this.chat,s.forEach(o=>{this.items.unshift({path:URL.createObjectURL(this.base64ToBlob(o)),name:t.slice(0,t.length>100?t.lastIndexOf(" ",100):100),mime:"image/png"})})}).catch(e=>{this.messages.add(this.$gettext("Error creating file")+`:
`+e,"error"),this.$log("FileAiDialog::create(): Error creating file",e)}).finally(()=>{this.loading=!1}))},record(){if(!this.audio)return this.audio=w().start();this.audio.then(e=>{this.dictating=!0,this.audio=null,e.stop().then(t=>{this.transcribe(t).then(s=>{this.chat=s.asText()}).finally(()=>{this.dictating=!1})})})},remove(e){this.items.splice(e,1)},removeSimilar(e){this.similar.splice(e,1)},use(e){this.similar.find(t=>t.path===e.path)||this.similar.push(e)}}},N={key:0},R=["onClick"],J=["src"],q={key:1},W={class:"item-preview"},z=["src"];function G(e,t,s,o,i,r){const F=U("FileListItems");return d(),p(O,{modelValue:s.modelValue,onAfterLeave:t[5]||(t[5]=n=>e.$emit("update:modelValue",!1)),"max-width":"1200",scrollable:""},{default:l(()=>[a(I,{loading:i.loading?"primary":!1},{append:l(()=>[a(m,{onClick:t[0]||(t[0]=n=>r.record()),class:T({dictating:i.audio}),icon:i.audio?"mdi-microphone-outline":"mdi-microphone",title:e.$gettext("Dictate"),loading:i.dictating,variant:"text"},null,8,["class","icon","title","loading"]),a(m,{onClick:t[1]||(t[1]=n=>e.$emit("update:modelValue",!1)),title:e.$gettext("Close"),icon:"mdi-close",variant:"text"},null,8,["title"])]),title:l(()=>[h(c(e.$gettext("Create image")),1)]),default:l(()=>[a(A,null,{default:l(()=>[a(D,{modelValue:i.chat,"onUpdate:modelValue":t[2]||(t[2]=n=>i.chat=n),label:e.$gettext("Describe the image"),variant:"underlined",autofocus:"",clearable:""},null,8,["modelValue","label"]),a(m,{loading:i.loading?"primary":!1,disabled:!i.chat||i.loading,onClick:t[3]||(t[3]=n=>r.create()),variant:"outlined",class:"create"},{default:l(()=>[h(c(e.$gettext("Create image")),1)]),_:1},8,["loading","disabled"]),i.items.length?(d(),g("div",N,[a(b,null,{default:l(()=>[a(v,null,{default:l(()=>[h(c(e.$gettext("Generated images")),1)]),_:1})]),_:1}),a(C,{class:"items grid"},{default:l(()=>[(d(!0),g($,null,k(i.items,(n,u)=>(d(),p(_,{key:u},{default:l(()=>[a(m,{onClick:x=>r.remove(u),title:e.$gettext("Remove"),class:"btn-overlay",icon:"mdi-delete"},null,8,["onClick","title"]),f("div",{class:"item-preview",onClick:x=>r.add(n)},[f("img",{src:r.url(n.path)},null,8,J)],8,R)]),_:2},1024))),128))]),_:1})])):V("",!0),i.similar.length?(d(),g("div",q,[a(b,null,{default:l(()=>[a(v,null,{default:l(()=>[h(c(e.$gettext("Use images of this style")),1)]),_:1})]),_:1}),a(C,{class:"items grid"},{default:l(()=>[(d(!0),g($,null,k(i.similar,(n,u)=>(d(),p(_,{key:u},{default:l(()=>[a(m,{icon:"mdi-delete",onClick:x=>r.removeSimilar(u),class:"btn-overlay",title:e.$gettext("Remove")},null,8,["onClick","title"]),f("div",W,[f("img",{src:r.url(n.path)},null,8,z)])]),_:2},1024))),128))]),_:1})])):V("",!0),a(b,null,{default:l(()=>[a(v,null,{default:l(()=>[h(c(e.$gettext("Select similar images")),1)]),_:1})]),_:1}),a(F,{ref:"filelist",filter:{mime:"image/"},onSelect:t[4]||(t[4]=n=>r.use(n))},null,512)]),_:1})]),_:1},8,["loading"])]),_:1},8,["modelValue"])}const K=S(E,[["render",G],["__scopeId","data-v-13ea3f73"]]);export{K as F};
