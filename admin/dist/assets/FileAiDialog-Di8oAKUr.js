import{_ as w,K as V,a2 as S,b as g,w as l,a4 as I,r as D,o as s,a,a5 as E,a6 as A,c as p,d as b,$ as N,h,k as m,t as c,a7 as v,a8 as $,a9 as y,F as C,a3 as k,aa as x,f}from"../index.js";import{F as O}from"./FileListItems-DVEk2ghK.js";const T={components:{FileListItems:O},props:{modelValue:{type:Boolean,required:!0},context:{type:[Object,null],default:null}},emits:["update:modelValue","add"],setup(){return{app:S()}},data(){return{input:"",items:[],errors:[],similar:[],loading:!1}},methods:{add(e){this.loading=!0,fetch(this.app.urlproxy.replace(":url",encodeURIComponent(e.path)),{credentials:"include",method:"GET"}).then(t=>{if(!t.ok)throw new Error(`Failed to fetch ${e.path}`,t);return t.blob()}).then(t=>{const o=e.name.replaceAll(" ","-")+"_"+new Date().toISOString().replace(/[^0-9]/g,"")+".png";return this.$apollo.mutate({mutation:V`mutation($input: FileInput, $file: Upload) {
              addFile(input: $input, file: $file) {
                id
                mime
                name
                path
                previews
                updated_at
                editor
              }
            }`,variables:{input:{name:e.name},file:new File([t],o,{type:e.mime})},context:{hasUpload:!0}})}).then(t=>{if(t.errors)throw t.errors;Object.assign(e,t.data.addFile,{previews:JSON.parse(t.data.addFile.previews||"{}")}),this.$emit("add",[e])}).catch(t=>{this.$log(`FileAiDialog::add(): Error adding file for ${e.path}`,t)}).finally(()=>{this.loading=!1})},create(){!this.input||this.loading||(this.loading=!0,this.original=this.input,this.$apollo.mutate({mutation:V`mutation($prompt: String!, $context: String, $files: [String!]) {
            imagine(prompt: $prompt, context: $context, files: $files)
          }`,variables:{prompt:this.input,context:this.context?$gettext("Context in JSON format")+`:
`+JSON.stringify(this.context):"",files:this.similar.map(e=>e.path)}}).then(e=>{if(e.errors)throw e.errors;const t=this.input,o=e.data.imagine;this.input=o.shift()||this.input,o.forEach(d=>{fetch(this.app.urlproxy.replace(":url",encodeURIComponent(d)),{credentials:"include",method:"HEAD"}).then(i=>{var r;if(!i.ok)throw new Error(`Failed to fetch ${d}`,i);this.items.unshift({path:d,mime:(r=i.headers)==null?void 0:r.get("Content-Type"),name:t.slice(0,t.lastIndexOf(" ",100))})}).catch(i=>{this.$log(`FileAiDialog::create(): Error fetching ${d}`,i)})})}).catch(e=>{this.$log("FileAiDialog::create(): Error creating files",e)}).finally(()=>{this.loading=!1}))},remove(e){this.items.splice(e,1)},removeSimilar(e){this.similar.splice(e,1)},url(e){return e.startsWith("http")||e.startsWith("blob:")?e:this.app.urlfile.replace(/\/+$/g,"")+"/"+e},use(e){this.similar.find(t=>t.path===e.path)||this.similar.push(e)}}},B={key:0},L=["onClick"],U=["src"],R={key:1},J={class:"item-preview"},j=["src"];function q(e,t,o,d,i,r){const F=D("FileListItems");return s(),g(I,{modelValue:o.modelValue,"max-width":"1200",scrollable:""},{default:l(()=>[a(E,{loading:i.loading?"primary":!1},{append:l(()=>[a(h,{onClick:t[0]||(t[0]=n=>e.$emit("update:modelValue",!1)),title:e.$gettext("Close"),icon:"mdi-close",variant:"flat"},null,8,["title"])]),title:l(()=>[m(c(e.$gettext("Create image")),1)]),default:l(()=>[a(A,null,{default:l(()=>[a(N,{modelValue:i.input,"onUpdate:modelValue":t[1]||(t[1]=n=>i.input=n),label:e.$gettext("Describe the image"),variant:"underlined",autofocus:"",clearable:""},null,8,["modelValue","label"]),a(h,{loading:i.loading?"primary":!1,disabled:!i.input||i.loading,onClick:t[2]||(t[2]=n=>r.create()),color:"primary",variant:"outlined",class:"create"},{default:l(()=>[m(c(e.$gettext("Create image")),1)]),_:1},8,["loading","disabled"]),i.items.length?(s(),p("div",B,[a(v,null,{default:l(()=>[a($,null,{default:l(()=>[m(c(e.$gettext("Generated images")),1)]),_:1})]),_:1}),a(y,{class:"items grid"},{default:l(()=>[(s(!0),p(C,null,k(i.items,(n,u)=>(s(),g(x,{key:u},{default:l(()=>[a(h,{onClick:_=>r.remove(u),title:e.$gettext("Remove"),class:"btn-overlay",icon:"mdi-delete"},null,8,["onClick","title"]),f("div",{class:"item-preview",onClick:_=>r.add(n)},[f("img",{src:r.url(n.path)},null,8,U)],8,L)]),_:2},1024))),128))]),_:1})])):b("",!0),i.similar.length?(s(),p("div",R,[a(v,null,{default:l(()=>[a($,null,{default:l(()=>[m(c(e.$gettext("Use images of this style")),1)]),_:1})]),_:1}),a(y,{class:"items grid"},{default:l(()=>[(s(!0),p(C,null,k(i.similar,(n,u)=>(s(),g(x,{key:u},{default:l(()=>[a(h,{icon:"mdi-delete",onClick:_=>r.removeSimilar(u),class:"btn-overlay",title:e.$gettext("Remove")},null,8,["onClick","title"]),f("div",J,[f("img",{src:r.url(n.path)},null,8,j)])]),_:2},1024))),128))]),_:1})])):b("",!0),a(v,null,{default:l(()=>[a($,null,{default:l(()=>[m(c(e.$gettext("Select similar images")),1)]),_:1})]),_:1}),a(F,{filter:{mime:"image/"},onSelect:t[3]||(t[3]=n=>r.use(n))})]),_:1})]),_:1},8,["loading"])]),_:1},8,["modelValue"])}const H=w(T,[["render",q],["__scopeId","data-v-5d95e52c"]]);export{H as F};
