import{_ as w,K as V,a4 as S,a2 as E,b as f,w as a,a5 as I,r as D,o as r,a as l,a6 as A,a7 as L,c,d as y,$ as N,h,k as m,t as p,a8 as v,a9 as $,aa as C,F as b,a3 as k,ab as x,f as g}from"../index.js";import{F as O}from"./FileListItems-Uwax8dPW.js";const T={components:{FileListItems:O},props:{modelValue:{type:Boolean,required:!0},context:{type:[Object,null],default:null}},emits:["update:modelValue","add"],inject:["url"],setup(){const e=S();return{app:E(),messages:e}},data(){return{input:"",items:[],errors:[],similar:[],loading:!1}},methods:{add(e){this.loading=!0,fetch(this.app.urlproxy.replace("_url_",encodeURIComponent(e.path)),{credentials:"include",method:"GET"}).then(t=>{if(!t.ok)throw new Error(`Failed to fetch ${e.path}`,t);return t.blob()}).then(t=>{const o=e.name.replaceAll(" ","-")+"_"+new Date().toISOString().replace(/[^0-9]/g,"")+".png";return this.$apollo.mutate({mutation:V`mutation($input: FileInput, $file: Upload) {
              addFile(input: $input, file: $file) {
                id
                mime
                name
                path
                previews
                updated_at
                editor
              }
            }`,variables:{input:{name:e.name},file:new File([t],o,{type:e.mime})},context:{hasUpload:!0}})}).then(t=>{if(t.errors)throw t.errors;Object.assign(e,t.data.addFile,{previews:JSON.parse(t.data.addFile.previews||"{}")}),this.$emit("add",[e])}).catch(t=>{this.messages.add(this.$gettext("Error adding file %{path}",{path:e==null?void 0:e.path}),"error"),this.$log("FileAiDialog::add(): Error adding file",t)}).finally(()=>{this.loading=!1})},create(){!this.input||this.loading||(this.loading=!0,this.original=this.input,this.$apollo.mutate({mutation:V`mutation($prompt: String!, $context: String, $files: [String!]) {
            imagine(prompt: $prompt, context: $context, files: $files)
          }`,variables:{prompt:this.input,context:this.context?$gettext("Context in JSON format")+`:
`+JSON.stringify(this.context):"",files:this.similar.map(e=>e.path)}}).then(e=>{if(e.errors)throw e.errors;const t=this.input,o=e.data.imagine;this.input=o.shift()||this.input,o.forEach(d=>{fetch(this.app.urlproxy.replace("_url_",encodeURIComponent(d)),{credentials:"include",method:"HEAD"}).then(i=>{var n;if(!i.ok)throw new Error(`Failed to fetch ${d}`,i);this.items.unshift({path:d,mime:(n=i.headers)==null?void 0:n.get("Content-Type"),name:t.slice(0,t.lastIndexOf(" ",100))})}).catch(i=>{this.$log(`FileAiDialog::create(): Error fetching ${d}`,i)})})}).catch(e=>{this.$log("FileAiDialog::create(): Error creating files",e)}).finally(()=>{this.loading=!1}))},remove(e){this.items.splice(e,1)},removeSimilar(e){this.similar.splice(e,1)},use(e){this.similar.find(t=>t.path===e.path)||this.similar.push(e)}}},B={key:0},U=["onClick"],R=["src"],j={key:1},J={class:"item-preview"},q=["src"];function G(e,t,o,d,i,n){const F=D("FileListItems");return r(),f(I,{modelValue:o.modelValue,onAfterLeave:t[4]||(t[4]=s=>e.$emit("update:modelValue",!1)),"max-width":"1200",scrollable:""},{default:a(()=>[l(A,{loading:i.loading?"primary":!1},{append:a(()=>[l(h,{onClick:t[0]||(t[0]=s=>e.$emit("update:modelValue",!1)),title:e.$gettext("Close"),icon:"mdi-close",variant:"flat"},null,8,["title"])]),title:a(()=>[m(p(e.$gettext("Create image")),1)]),default:a(()=>[l(L,null,{default:a(()=>[l(N,{modelValue:i.input,"onUpdate:modelValue":t[1]||(t[1]=s=>i.input=s),label:e.$gettext("Describe the image"),variant:"underlined",autofocus:"",clearable:""},null,8,["modelValue","label"]),l(h,{loading:i.loading?"primary":!1,disabled:!i.input||i.loading,onClick:t[2]||(t[2]=s=>n.create()),color:"primary",variant:"outlined",class:"create"},{default:a(()=>[m(p(e.$gettext("Create image")),1)]),_:1},8,["loading","disabled"]),i.items.length?(r(),c("div",B,[l(v,null,{default:a(()=>[l($,null,{default:a(()=>[m(p(e.$gettext("Generated images")),1)]),_:1})]),_:1}),l(C,{class:"items grid"},{default:a(()=>[(r(!0),c(b,null,k(i.items,(s,u)=>(r(),f(x,{key:u},{default:a(()=>[l(h,{onClick:_=>n.remove(u),title:e.$gettext("Remove"),class:"btn-overlay",icon:"mdi-delete"},null,8,["onClick","title"]),g("div",{class:"item-preview",onClick:_=>n.add(s)},[g("img",{src:n.url(s.path)},null,8,R)],8,U)]),_:2},1024))),128))]),_:1})])):y("",!0),i.similar.length?(r(),c("div",j,[l(v,null,{default:a(()=>[l($,null,{default:a(()=>[m(p(e.$gettext("Use images of this style")),1)]),_:1})]),_:1}),l(C,{class:"items grid"},{default:a(()=>[(r(!0),c(b,null,k(i.similar,(s,u)=>(r(),f(x,{key:u},{default:a(()=>[l(h,{icon:"mdi-delete",onClick:_=>n.removeSimilar(u),class:"btn-overlay",title:e.$gettext("Remove")},null,8,["onClick","title"]),g("div",J,[g("img",{src:n.url(s.path)},null,8,q)])]),_:2},1024))),128))]),_:1})])):y("",!0),l(v,null,{default:a(()=>[l($,null,{default:a(()=>[m(p(e.$gettext("Select similar images")),1)]),_:1})]),_:1}),l(F,{filter:{mime:"image/"},onSelect:t[3]||(t[3]=s=>n.use(s))})]),_:1})]),_:1},8,["loading"])]),_:1},8,["modelValue"])}const M=w(T,[["render",G],["__scopeId","data-v-5ac73937"]]);export{M as F};
