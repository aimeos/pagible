import{_ as S,L as y,a6 as w,a4 as L,b as f,o as d,w as i,a7 as B,r as O,a,a8 as U,a9 as I,c as p,d as V,a1 as A,k as g,l as m,t as h,aa as b,ab as v,i as $,F as _,a5 as C,j as k,f as c}from"./index-CbGv5iX_.js";import{F as j}from"./FileListItems-DrTEpsYp.js";const D={components:{FileListItems:j},props:{modelValue:{type:Boolean,required:!0},context:{type:[Object,null],default:null}},emits:["update:modelValue","add"],inject:["slugify","url"],setup(){const e=w();return{app:L(),messages:e}},data(){return{input:"",items:[],errors:[],similar:[],loading:!1}},beforeUpdate(){var e,t,s;this.input=[(e=this.context)==null?void 0:e.title,(t=this.context)==null?void 0:t.text,(s=this.context)==null?void 0:s.description].filter(Boolean).join(`
`)},unmounted(){this.items.forEach(e=>{e.path.startsWith("blob:")&&URL.revokeObjectURL(e.path)}),this.similar=[],this.items=[]},methods:{add(e){if(!e.path.startsWith("blob:")){this.$emit("add",[e]);return}this.loading=!0,fetch(e.path).then(t=>t.blob()).then(t=>{const s=e.name.slice(0,e.name.length>50?e.name.lastIndexOf(" ",50):50)||"ai-image",r=this.slugify(s)+"_"+new Date().toISOString().replace(/[^0-9]/g,"")+".png";return this.$apollo.mutate({mutation:y`mutation($input: FileInput, $file: Upload) {
              addFile(input: $input, file: $file) {
                id
                mime
                name
                path
                previews
                updated_at
                editor
              }
            }`,variables:{input:{name:e.name},file:new File([t],r,{type:e.mime})},context:{hasUpload:!0}})}).then(t=>{if(t.errors)throw t.errors;Object.assign(e,t.data.addFile,{previews:JSON.parse(t.data.addFile.previews||"{}")}),this.$emit("add",[e])}).catch(t=>{this.messages.add(this.$gettext("Error adding file %{path}",{path:e==null?void 0:e.path})+`:
`+t,"error"),this.$log("FileAiDialog::add(): Error adding file",t)}).finally(()=>{this.loading=!1})},base64ToBlob(e,t="image/png"){if(!e)return null;const s=atob(e),r=new Uint8Array(s.length);for(let l=0;l<s.length;l++)r[l]=s.charCodeAt(l);return new Blob([r],{type:t})},create(){!this.input||this.loading||(this.loading=!0,this.original=this.input,this.$apollo.mutate({mutation:y`mutation($prompt: String!, $context: String, $files: [String!]) {
            imagine(prompt: $prompt, context: $context, files: $files)
          }`,variables:{prompt:this.input||"Create a suitable image based on the context",context:this.context?`Context in JSON format:
`+JSON.stringify(this.context):"",files:this.similar.map(e=>e.path)}}).then(e=>{if(e.errors)throw e.errors;const t=this.input,s=e.data.imagine;this.input=s.shift()||this.input,s.forEach(r=>{this.items.unshift({path:URL.createObjectURL(this.base64ToBlob(r)),name:t.slice(0,t.length>100?t.lastIndexOf(" ",100):100),mime:"image/png"})})}).catch(e=>{this.messages.add(this.$gettext("Error creating file")+`:
`+e,"error"),this.$log("FileAiDialog::create(): Error creating file",e)}).finally(()=>{this.loading=!1}))},remove(e){this.items.splice(e,1)},removeSimilar(e){this.similar.splice(e,1)},use(e){this.similar.find(t=>t.path===e.path)||this.similar.push(e)}}},E={key:0},N=["onClick"],T=["src"],R={key:1},J={class:"item-preview"},q=["src"];function W(e,t,s,r,l,o){const F=O("FileListItems");return d(),f(B,{modelValue:s.modelValue,onAfterLeave:t[4]||(t[4]=n=>e.$emit("update:modelValue",!1)),"max-width":"1200",scrollable:""},{default:i(()=>[a(U,{loading:l.loading?"primary":!1},{append:i(()=>[a(g,{onClick:t[0]||(t[0]=n=>e.$emit("update:modelValue",!1)),title:e.$gettext("Close"),icon:"mdi-close",variant:"text",elevation:"0"},null,8,["title"])]),title:i(()=>[m(h(e.$gettext("Create image")),1)]),default:i(()=>[a(I,null,{default:i(()=>[a(A,{modelValue:l.input,"onUpdate:modelValue":t[1]||(t[1]=n=>l.input=n),label:e.$gettext("Describe the image"),variant:"underlined",autofocus:"",clearable:""},null,8,["modelValue","label"]),a(g,{loading:l.loading?"primary":!1,disabled:!l.input||l.loading,onClick:t[2]||(t[2]=n=>o.create()),variant:"outlined",class:"create"},{default:i(()=>[m(h(e.$gettext("Create image")),1)]),_:1},8,["loading","disabled"]),l.items.length?(d(),p("div",E,[a(b,null,{default:i(()=>[a(v,null,{default:i(()=>[m(h(e.$gettext("Generated images")),1)]),_:1})]),_:1}),a($,{class:"items grid"},{default:i(()=>[(d(!0),p(_,null,C(l.items,(n,u)=>(d(),f(k,{key:u},{default:i(()=>[a(g,{onClick:x=>o.remove(u),title:e.$gettext("Remove"),class:"btn-overlay",icon:"mdi-delete"},null,8,["onClick","title"]),c("div",{class:"item-preview",onClick:x=>o.add(n)},[c("img",{src:o.url(n.path)},null,8,T)],8,N)]),_:2},1024))),128))]),_:1})])):V("",!0),l.similar.length?(d(),p("div",R,[a(b,null,{default:i(()=>[a(v,null,{default:i(()=>[m(h(e.$gettext("Use images of this style")),1)]),_:1})]),_:1}),a($,{class:"items grid"},{default:i(()=>[(d(!0),p(_,null,C(l.similar,(n,u)=>(d(),f(k,{key:u},{default:i(()=>[a(g,{icon:"mdi-delete",onClick:x=>o.removeSimilar(u),class:"btn-overlay",title:e.$gettext("Remove")},null,8,["onClick","title"]),c("div",J,[c("img",{src:o.url(n.path)},null,8,q)])]),_:2},1024))),128))]),_:1})])):V("",!0),a(b,null,{default:i(()=>[a(v,null,{default:i(()=>[m(h(e.$gettext("Select similar images")),1)]),_:1})]),_:1}),a(F,{ref:"filelist",filter:{mime:"image/"},onSelect:t[3]||(t[3]=n=>o.use(n))},null,512)]),_:1})]),_:1},8,["loading"])]),_:1},8,["modelValue"])}const z=S(D,[["render",W],["__scopeId","data-v-192c5dd2"]]);export{z as F};
