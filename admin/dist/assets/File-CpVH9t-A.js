import{_ as U,K as L,a4 as C,a1 as x,a2 as R,c as V,a as i,b as m,w as a,V as p,r as y,T as F,F as D,o as n,d as c,e as r,f as v,n as j,k as u,g as A,t as f,h as g,i as O,j as B}from"../index.js";import{a as b,F as M}from"./FileListItems-Uwax8dPW.js";import{a as S,F as z}from"./FileDialog-CY6NF1wI.js";import"./utils-BVXTMPFA.js";const I={components:{FileListItems:M,FileUrlDialog:z,FileDetail:b,FileDialog:S},inject:["openView","url","srcset"],props:{modelValue:{type:[Object,null],default:()=>null},config:{type:Object,default:()=>{}},assets:{type:Object,default:()=>{}},readonly:{type:Boolean,default:!1}},emits:["update:modelValue","error","addFile","removeFile"],data(){return{file:{},index:Math.floor(Math.random()*1e5),selected:null,vfiles:!1,vurls:!1}},setup(){const e=C(),l=x();return{app:R(),auth:l,messages:e}},unmounted(){var e,l;(l=(e=this.file)==null?void 0:e.path)!=null&&l.startsWith("blob:")&&URL.revokeObjectURL(this.file.path)},methods:{add(e){if(!this.auth.can("file:add")){this.messages.add(this.$gettext("Permission denied"),"error");return}if(!e)return;const l=URL.createObjectURL(e);return this.file={path:l,uploading:!0},this.$apollo.mutate({mutation:L`mutation($file: Upload!) {
            addFile(file: $file) {
              id
              mime
              name
              path
              previews
              updated_at
              editor
            }
          }`,variables:{file:e},context:{hasUpload:!0}}).then(o=>{var t;if(o.errors)throw o.errors;const d=((t=o.data)==null?void 0:t.addFile)||{};return d.previews=JSON.parse(d.previews)||{},delete d.__typename,this.handle(d,l)}).catch(o=>{var d;this.messages.add(this.$gettext("Error adding file %{path}",{path:(d=files[0])==null?void 0:d.name}),"error"),this.$log("File::addFile(): Error adding file",ev,o)}).finally(()=>{this.selected=null})},handle(e,l){if(!(e!=null&&e.id)){this.$log("File::handle(): Invalid item without ID",e);return}return this.file={...e},this.$emit("addFile",e),this.$emit("update:modelValue",{id:e.id,type:"file"}),this.validate(),l!=null&&l.startsWith("blob:")&&URL.revokeObjectURL(l),e},open(e){this.openView(b,{item:e})},remove(){this.file.path.startsWith("blob:")&&URL.revokeObjectURL(this.file.path),this.file.id&&this.$emit("removeFile",this.file.id),this.$emit("update:modelValue",null),this.file={},this.validate()},select(e){if(!Array.isArray(e)||!e.length){this.$log("File::select(): Items must be a non-empty array",e);return}const l=e.shift();this.file={...l},this.$emit("addFile",l),this.$emit("update:modelValue",{id:l.id,type:"file"}),this.validate()},async validate(){const e=!!(!this.config.required||this.file.path);return this.$emit("error",!e),await e}},watch:{assets:{handler(e){!this.file.path&&this.modelValue&&e[this.modelValue.id]&&(this.file=e[this.modelValue.id]),this.validate()}},modelValue:{immediate:!0,handler(e){!this.file.path&&e&&this.assets[e.id]&&(this.file=this.assets[e.id]),this.validate()}}}},N={key:1,class:"file"};function _(e,l,o,d,t,h){const w=y("FileDialog"),k=y("FileUrlDialog");return n(),V(D,null,[i(p,null,{default:a(()=>[i(r,{cols:"12",md:"6"},{default:a(()=>[v("div",{class:j(["files",{readonly:o.readonly}])},[t.file.path?(n(),V("div",{key:0,class:"file",onClick:l[1]||(l[1]=s=>h.open(t.file))},[t.file.uploading?(n(),m(A,{key:0,color:"primary",height:"5",indeterminate:"",rounded:""})):c("",!0),l[10]||(l[10]=v("svg",{draggable:"false",xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",fill:"currentColor",class:"bi bi-file-earmark-binary",viewBox:"0 0 16 16"},[v("path",{d:"M7.05 11.885c0 1.415-.548 2.206-1.524 2.206C4.548 14.09 4 13.3 4 11.885c0-1.412.548-2.203 1.526-2.203.976 0 1.524.79 1.524 2.203m-1.524-1.612c-.542 0-.832.563-.832 1.612q0 .133.006.252l1.559-1.143c-.126-.474-.375-.72-.733-.72zm-.732 2.508c.126.472.372.718.732.718.54 0 .83-.563.83-1.614q0-.129-.006-.25zm6.061.624V14h-3v-.595h1.181V10.5h-.05l-1.136.747v-.688l1.19-.786h.69v3.633z"}),v("path",{d:"M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2M9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5z"})],-1)),u(" "+f(t.file.name)+" ",1),!o.readonly&&t.file.path?(n(),m(g,{key:1,onClick:l[0]||(l[0]=O(s=>h.remove(),["stop"])),title:e.$gettext("Remove file"),icon:"mdi-trash-can",class:"btn-overlay",variant:"flat"},null,8,["title"])):c("",!0)])):o.readonly?c("",!0):(n(),V("div",N,[d.auth.can("file:view")?(n(),m(g,{key:0,onClick:l[2]||(l[2]=s=>t.vfiles=!0),title:e.$gettext("Add file"),icon:"mdi-button-cursor",variant:"flat"},null,8,["title"])):c("",!0),i(g,{onClick:l[3]||(l[3]=s=>t.vurls=!0),title:e.$gettext("Add file from URL"),icon:"mdi-link-variant-plus",variant:"flat"},null,8,["title"]),i(g,{title:e.$gettext("Upload file"),icon:"mdi-upload",variant:"flat"},{default:a(()=>[i(B,{modelValue:t.selected,"onUpdate:modelValue":[l[4]||(l[4]=s=>t.selected=s),l[5]||(l[5]=s=>h.add(s))],accept:o.config.accept||"*","hide-input":!0,"prepend-icon":"mdi-upload"},null,8,["modelValue","accept"])]),_:1},8,["title"])]))],2)]),_:1}),t.file.path?(n(),m(r,{key:0,cols:"12",md:"6",class:"meta"},{default:a(()=>[i(p,null,{default:a(()=>[i(r,{cols:"12",md:"3",class:"name"},{default:a(()=>[u(f(e.$gettext("name"))+":",1)]),_:1}),i(r,{cols:"12",md:"9"},{default:a(()=>[u(f(t.file.name),1)]),_:1})]),_:1}),i(p,null,{default:a(()=>[i(r,{cols:"12",md:"3",class:"name"},{default:a(()=>[u(f(e.$gettext("mime"))+":",1)]),_:1}),i(r,{cols:"12",md:"9"},{default:a(()=>[u(f(t.file.mime),1)]),_:1})]),_:1}),i(p,null,{default:a(()=>[i(r,{cols:"12",md:"3",class:"name"},{default:a(()=>[u(f(e.$gettext("editor"))+":",1)]),_:1}),i(r,{cols:"12",md:"9"},{default:a(()=>[u(f(t.file.editor),1)]),_:1})]),_:1}),i(p,null,{default:a(()=>[i(r,{cols:"12",md:"3",class:"name"},{default:a(()=>[u(f(e.$gettext("updated"))+":",1)]),_:1}),i(r,{cols:"12",md:"9"},{default:a(()=>[u(f(new Date(t.file.updated_at).toLocaleString()),1)]),_:1})]),_:1})]),_:1})):c("",!0)]),_:1}),(n(),m(F,{to:"body"},[i(w,{modelValue:t.vfiles,"onUpdate:modelValue":l[6]||(l[6]=s=>t.vfiles=s),onAdd:l[7]||(l[7]=s=>{h.handle(s),t.vfiles=!1})},null,8,["modelValue"])])),(n(),m(F,{to:"body"},[i(k,{modelValue:t.vurls,"onUpdate:modelValue":l[8]||(l[8]=s=>t.vurls=s),onAdd:l[9]||(l[9]=s=>{h.select(s),t.vurls=!1})},null,8,["modelValue"])]))],64)}const H=U(I,[["render",_]]);export{H as default};
