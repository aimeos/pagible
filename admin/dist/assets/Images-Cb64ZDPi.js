import{_ as D,c as V,o as r,a as o,b as u,w as n,r as y,T as b,F as x,L,a3 as j,a4 as O,d as c,a5 as I,n as R,g as E,a2 as B,h as M,i as N,j as k,k as g,l as U,t as w,m as P,f as A,p as _}from"./index-CbGv5iX_.js";import{l as S}from"./vue-draggable-plus-CEFFyQ5b.js";import{F as T}from"./FileAiDialog-CBX27C8p.js";import{F as q,a as C}from"./FileListItems-DrTEpsYp.js";import{F as z,a as J}from"./FileDialog-XMbI5Zu2.js";import"./ElementListItems-C-VLYrD-.js";import"./PageDetail-DAelKlRD.js";import"./ElementDetail-DKP9HuyS.js";const W={components:{FileDetail:C,FileDialog:J,FileAiDialog:T,FileUrlDialog:z,FileListItems:q,VueDraggable:S},inject:["openView","url","srcset"],props:{modelValue:{type:Array,default:()=>[]},config:{type:Object,default:()=>{}},assets:{type:Object,default:()=>{}},readonly:{type:Boolean,default:!1},context:{type:Object}},emits:["update:modelValue","error","addFile","removeFile"],setup(){const t=j();return{app:O(),auth:t}},data(){return{images:[],index:Math.floor(Math.random()*1e5),selected:null,vcreate:!1,vfiles:!1,vurls:!1}},computed:{rules(){return[t=>!this.config.min||+(t==null?void 0:t.length)>=+this.config.min||this.$gettext("Minimum is %{num} entries",{num:this.config.min}),t=>!this.config.max||+(t==null?void 0:t.length)<=+this.config.max||this.$gettext("Maximum is %{num} entries",{num:this.config.max})]}},unmounted(){this.images.forEach(t=>{var e;(e=t.path)!=null&&e.startsWith("blob:")&&URL.revokeObjectURL(t.path)})},methods:{add(t){if(!this.auth.can("file:add")){this.messages.add(this.$gettext("Permission denied"),"error");return}const e=[];t!=null&&t.length&&(Array.from(t).forEach(a=>{const f=URL.createObjectURL(a),l=this.images.length;this.images[l]={path:f,uploading:!0};const s=this.$apollo.mutate({mutation:L`mutation($file: Upload!) {
              addFile(file: $file) {
                id
                mime
                name
                path
                previews
              }
            }`,variables:{file:a},context:{hasUpload:!0}}).then(d=>{var h;if(d.errors)throw d.errors;const m=((h=d.data)==null?void 0:h.addFile)||{};return m.previews=JSON.parse(m.previews)||{},delete m.__typename,new Promise((F,i)=>{const p=new Image;p.onload=F,p.onerror=i,p.src=this.url(Object.values(m.previews)[0])}).then(()=>{this.images[l]=m,this.$emit("addFile",m),URL.revokeObjectURL(f)})}).catch(d=>{this.messages.add(this.$gettext("Error adding file %{path}",{path:a.name})+`:
`+d,"error"),this.$log("Images::addFile(): Error adding file",ev,d)});e.push(s)}),Promise.all(e).then(()=>{this.$emit("update:modelValue",this.images.map(a=>({id:a.id,type:"file"})))}),this.selected=null)},change(){this.$emit("update:modelValue",this.images.map(t=>({id:t.id,type:"file"})))},description(t){return Object.values(t.description||{}).shift()},open(t){this.openView(C,{item:t})},remove(t){var e;(e=this.images[t])!=null&&e.id&&this.$emit("removeFile",this.images[t].id),this.images.splice(t,1),this.$emit("update:modelValue",this.images.map(a=>({id:a.id,type:"file"})))},select(t){Array.isArray(t)||(t=[t]),t.forEach(e=>{this.images.push(e),this.$emit("addFile",e)}),this.$emit("update:modelValue",this.images.map(e=>({id:e.id,type:"file"}))),this.vfiles=!1,this.vurls=!1}},watch:{modelValue:{immediate:!0,handler(t){if(!this.images.length)for(const e of t||[])this.assets[e.id]&&this.images.push(this.assets[e.id]);this.$emit("error",!this.rules.every(e=>e(this.modelValue)===!0))}}}},G=["onClick","title"],H={key:0,class:"add"},K={class:"icon-group"},Q={class:"icon-group"};function X(t,e,a,f,l,s){const d=y("VueDraggable"),m=y("FileDialog"),h=y("FileAiDialog"),F=y("FileUrlDialog");return r(),V(x,null,[o(d,{modelValue:l.images,"onUpdate:modelValue":e[5]||(e[5]=i=>l.images=i),disabled:a.readonly,onUpdate:e[6]||(e[6]=i=>s.change()),draggable:".image",group:"images",class:"images",animation:"500"},{default:n(()=>[(r(!0),V(x,null,I(l.images,(i,p)=>(r(),V("div",{key:p,class:R([{readonly:a.readonly},"image"]),onClick:v=>s.open(i),title:s.description(i)},[i.uploading?(r(),u(E,{key:0,color:"primary",height:"5",indeterminate:"",rounded:""})):c("",!0),i.path?(r(),u(B,{key:1,srcset:s.srcset(i.previews),src:s.url(i.path),draggable:"false"},null,8,["srcset","src"])):c("",!0),i.id&&!a.readonly?(r(),u(M,{key:2},{activator:n(({props:v})=>[o(g,P({ref_for:!0},v,{title:t.$gettext("Open menu"),icon:"mdi-dots-vertical",class:"btn-overlay",variant:"text",elevation:"0"}),null,16,["title"])]),default:n(()=>[o(N,null,{default:n(()=>[f.auth.can("file:view")?(r(),u(k,{key:0},{default:n(()=>[o(g,{onClick:v=>s.open(i),"prepend-icon":"mdi-pencil",variant:"text",elevation:"0"},{default:n(()=>[U(w(t.$gettext("Edit")),1)]),_:1},8,["onClick"])]),_:2},1024)):c("",!0),o(k,null,{default:n(()=>[o(g,{onClick:v=>s.remove(p),"prepend-icon":"mdi-trash-can",variant:"text",elevation:"0"},{default:n(()=>[U(w(t.$gettext("Remove")),1)]),_:1},8,["onClick"])]),_:2},1024)]),_:2},1024)]),_:2},1024)):c("",!0)],10,G))),128)),a.readonly?c("",!0):(r(),V("div",H,[A("div",K,[f.auth.can("file:view")?(r(),u(g,{key:0,onClick:e[0]||(e[0]=i=>l.vfiles=!0),title:t.$gettext("Add files"),icon:"mdi-button-cursor",variant:"text",elevation:"0"},null,8,["title"])):c("",!0),o(g,{onClick:e[1]||(e[1]=i=>l.vurls=!0),title:t.$gettext("Add files from URLs"),icon:"mdi-link-variant-plus",variant:"text",elevation:"0"},null,8,["title"])]),A("div",Q,[o(g,{onClick:e[2]||(e[2]=i=>l.vcreate=!0),title:t.$gettext("Create file"),icon:"mdi-creation",variant:"text",elevation:"0"},null,8,["title"]),o(g,{title:t.$gettext("Add files"),icon:"mdi-upload",variant:"text",elevation:"0"},{default:n(()=>[o(_,{modelValue:l.selected,"onUpdate:modelValue":[e[3]||(e[3]=i=>l.selected=i),e[4]||(e[4]=i=>s.add(i))],accept:a.config.accept||"image/*","hide-input":!0,"prepend-icon":"mdi-upload",multiple:""},null,8,["modelValue","accept"])]),_:1},8,["title"])])]))]),_:1},8,["modelValue","disabled"]),(r(),u(b,{to:"body"},[o(m,{modelValue:l.vfiles,"onUpdate:modelValue":e[7]||(e[7]=i=>l.vfiles=i),onAdd:e[8]||(e[8]=i=>s.select(i)),filter:{mime:"image/"},grid:""},null,8,["modelValue"])])),(r(),u(b,{to:"body"},[o(h,{modelValue:l.vcreate,"onUpdate:modelValue":e[9]||(e[9]=i=>l.vcreate=i),onAdd:e[10]||(e[10]=i=>{s.select(i),l.vcreate=!1}),context:a.context},null,8,["modelValue","context"])])),(r(),u(b,{to:"body"},[o(F,{modelValue:l.vurls,"onUpdate:modelValue":e[11]||(e[11]=i=>l.vurls=i),onAdd:e[12]||(e[12]=i=>s.select(i)),mime:"image/",multiple:""},null,8,["modelValue"])]))],64)}const se=D(W,[["render",X],["__scopeId","data-v-5d1ad745"]]);export{se as default};
